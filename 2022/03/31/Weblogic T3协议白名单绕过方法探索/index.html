<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Weblogic T3协议白名单绕过方法探索 - YYHYlh&#39;s blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 6.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 常记常新 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>YYHYlh</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E5%8D%8F%E5%95%86"><span class="toc-text">0x01 协商</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E4%BF%A1%E6%81%AF%E5%8F%91%E9%80%81"><span class="toc-text">0x02 信息发送</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-text">白名单绕过</span></a>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 常记常新 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Weblogic T3协议白名单绕过方法探索
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2022-03-31 23:16:25</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#漏洞分析" title="漏洞分析">漏洞分析</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#安全技术" title="安全技术">安全技术</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <pre><code>本文首发于先知社区:https://xz.aliyun.com/t/11087
</code></pre>
<p>去年weblogic出白名单时研究了下怎么绕过，总结出了下面的思路，本想再找找有无新的攻击面的思路，但是找了几次都没找到，后来就搁置了。昨天看见<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11037" title="https://xz.aliyun.com/t/11037">https://xz.aliyun.com/t/11037</a>这篇文章，提到了T3协议绕过，才想起自己也搞过这块的研究，遂将研究的内容分享出来抛砖引玉，希望能看到大佬们更多的分析文章。</p>
<h3 id="0x01-协商"><a href="#0x01-协商" class="headerlink" title="0x01 协商"></a>0x01 协商</h3><p>Weblogic处理T3基础信息协商的类如下</p>
<p>weblogic.rjvm.t3.MuxableSocketT3#readIncomingConnectionBootstrapMessage</p>
<p>客户端发送：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t3 <span class="number">10.3</span><span class="number">.6</span></span><br><span class="line">AS:<span class="number">255</span></span><br><span class="line">HL:<span class="number">19</span></span><br></pre></td></tr></table></figure>

<p>服务端发送：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HELO:<span class="number">12.2</span><span class="number">.1</span><span class="number">.4</span>.<span class="literal">false</span></span><br><span class="line">AS:<span class="number">2048</span></span><br><span class="line">HL:<span class="number">19</span></span><br><span class="line">MS:<span class="number">10000000</span></span><br><span class="line">PN:DOMAIN</span><br></pre></td></tr></table></figure>

<p>客户端发送的都是这种键值对的形式，存在以下可用键：</p>
<p><img src="/img/t3/image_x1MdK_tRne.png"></p>
<p>其中，AS和HL是两种常用的头信息，这里和我们利用的关系不大，就不分析了，需要注意的时候AS需要设置成01，尽可能小。</p>
<h3 id="0x02-信息发送"><a href="#0x02-信息发送" class="headerlink" title="0x02 信息发送"></a>0x02 信息发送</h3><p>信息处理的主要代码在weblogic.rjvm.MsgAbbrevInputStream#init函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>.init(data, <span class="number">4</span>);#变量初始化，以及跳过一个<span class="type">int</span>（数据总长度）</span><br><span class="line"><span class="built_in">this</span>.connection = connection;</span><br><span class="line"><span class="built_in">this</span>.responseId = -<span class="number">1</span>;</span><br><span class="line"><span class="built_in">this</span>.user = <span class="literal">null</span>;</span><br><span class="line"><span class="built_in">this</span>.setValidatingClass(<span class="literal">false</span>);</span><br><span class="line"><span class="built_in">this</span>.header.readHeader(<span class="built_in">this</span>, connection.getRemoteHeaderLength());#读取header信息</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.connectionManager.thisRJVM != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.header.src = <span class="built_in">this</span>.connectionManager.thisRJVM.getID();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.header.dest = JVMID.localID();</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.requiresUnauthenticatedFilter()) &#123;</span><br><span class="line">    WebLogicObjectInputFilter.setUnauthenticatedFilterForStream(<span class="built_in">this</span>.objectStream);</span><br><span class="line">    <span class="built_in">this</span>.objectStream.setFilterType(MsgAbbrevInputStream.FilterType.UNAUTHENTICATED);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.objectStream.getFilterType() == <span class="literal">null</span>) &#123;</span><br><span class="line">    WebLogicObjectInputFilter.setWebLogicFilterForStream(<span class="built_in">this</span>.objectStream);</span><br><span class="line">    <span class="built_in">this</span>.objectStream.setFilterType(MsgAbbrevInputStream.FilterType.WLS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (KernelStatus.DEBUG &amp;&amp; debugMessaging.isDebugEnabled()) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.mark(<span class="built_in">this</span>.header.abbrevOffset);</span><br><span class="line"><span class="built_in">this</span>.skip((<span class="type">long</span>)(<span class="built_in">this</span>.header.abbrevOffset - <span class="built_in">this</span>.pos()));</span><br><span class="line">connection.readMsgAbbrevs(<span class="built_in">this</span>);</span><br><span class="line"><span class="built_in">this</span>.reset();</span><br><span class="line"><span class="keyword">if</span> (JVMID.localID().equals(<span class="built_in">this</span>.header.dest)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.header.getFlag(<span class="number">8</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.read81Contexts();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.readExtendedContexts();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一步super.init()会进行一些初始化，并跳过前面的4个byte的长度信息，首先读取的就是header信息，处理函数如下weblogic.rjvm.JVMMessage#readHeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cmd = JVMMessage.Command.getByValue(is.readByte());</span><br><span class="line">    <span class="built_in">this</span>.QOS = is.readByte();</span><br><span class="line">    <span class="built_in">this</span>.flags = is.readByte() &amp; <span class="number">255</span>;</span><br><span class="line">    <span class="built_in">this</span>.hasJVMIDs = <span class="built_in">this</span>.getFlag(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">this</span>.hasTX = <span class="built_in">this</span>.getFlag(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">this</span>.hasTrace = <span class="built_in">this</span>.getFlag(<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">this</span>.responseId = is.readInt();</span><br><span class="line">    <span class="built_in">this</span>.invokableId = is.readInt();</span><br><span class="line">    <span class="built_in">this</span>.abbrevOffset = is.readInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">skip</span> <span class="operator">=</span> remoteHeaderLen - <span class="number">19</span>;</span><br><span class="line">    <span class="keyword">if</span> (skip &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        is.skip((<span class="type">long</span>)skip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Exception reading message header&quot;</span>, var4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总的一共是19个byte</p>
<p>这里说一些比较重要的</p>
<ul>
<li>cmd，代表的是执行指令，这个值会影响代码进入不同的处理分支</li>
<li>flags，一个标志位，标识数据包中的信息种类，同样会影响代码进入不同分支</li>
<li>abbreOffset，一个int变量，标识header长度，在后面对流的控制会用到。</li>
</ul>
<p>在读取完header后，会调用mark和skip函数，标记当前位置，并跳过一部分内容，跳过的长度为abbrevOffset 的值-当前读取的长度，然后调用connection.readMsgAbbrevs(this);读取信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.skip((<span class="type">long</span>)(<span class="built_in">this</span>.header.abbrevOffset - <span class="built_in">this</span>.pos()));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>readMsgAbbrevs函数就会对流中的序列化数据进行反序列化，调用的是InboundMsgAbbrev类的readObject方法，并存储在栈中。调用栈如下</p>
<p><img src="/img/t3/image_VJur-EPSmQ.png"></p>
<p>会调用到FilteringObjectInputStream的resolveClass函数。这里也就是之前weblogic的漏洞会触发的readObject的地方。但是在21年4月的补丁中，Weblogic使用了白名单，只有以下七种类可以被反序列化，因此所有Weblogic原本的漏洞都无法使用。</p>
<ul>
<li>java.lang.String</li>
<li>weblogic.rmi.spi.ServiceContext</li>
<li>weblogic.rjvm.ClassTableEntry</li>
<li>weblogic.rjvm.JVMID</li>
<li>weblogic.security.acl.internal.AuthenticatedUser</li>
<li>weblogic.rmi.extensions.server.RuntimeMethodDescriptor</li>
<li>weblogic.utils.io.Immutable</li>
</ul>
<p>读取结束后，执行reset()方法，流的指针回到之前mark处，根据header中flag值的不同，进入不同的分支。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">this</span>.header.getFlag(<span class="number">8</span>)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.read81Contexts();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.readExtendedContexts();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据需求设定flag值，可以进入如下函数</p>
<p><img src="/img/t3/image_4IdYPRPbT9.png"></p>
<p>该函数的关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (b == <span class="number">4</span>) &#123;</span><br><span class="line">  <span class="type">ObjectStreamClass</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="built_in">this</span>.readClassDescriptor();</span><br><span class="line">  <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="built_in">this</span>.resolveClass(desc);</span><br><span class="line">  weblogic.utils.io.<span class="type">ObjectStreamClass</span> <span class="variable">osc</span> <span class="operator">=</span> weblogic.utils.io.ObjectStreamClass.lookup(cl);</span><br><span class="line">  <span class="type">Externalizable</span> <span class="variable">e</span> <span class="operator">=</span> (Externalizable)osc.newInstance();</span><br><span class="line">  <span class="type">int</span> <span class="variable">envelopeLength</span> <span class="operator">=</span> <span class="built_in">this</span>.readInt();</span><br><span class="line">  <span class="type">int</span> <span class="variable">startEnvelope</span> <span class="operator">=</span> <span class="built_in">this</span>.pos();</span><br><span class="line">  <span class="built_in">this</span>.pushExternalizableInfo(startEnvelope + envelopeLength, cl.getName());</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">var12</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      var12 = <span class="literal">true</span>;</span><br><span class="line">      e.readExternal(<span class="built_in">this</span>);</span><br><span class="line">      var12 = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码就是T3白名单绕过的关键部分了。</p>
<h2 id="白名单绕过"><a href="#白名单绕过" class="headerlink" title="白名单绕过"></a>白名单绕过</h2><p>上面的函数中实例化了一个实现了Externalizable接口的类，并调用了它的readExternal。这个类的Desc信息来源于<code>this.readClassDescriptor();</code>这个函数会从栈中的ClassTableEntry中读取descriptor属性作为desc，接着调用resovleClass方法生成类，这里调用的是MsgAbbrevInputStream的resolveClass方法，只存在黑名单判断，不存在白名单。接着会实例化这个类，并调用readExternal方法。栈中的ClassTableEntry类是在Weblogic T3的白名单中的，因此可以顺利被传入。</p>
<p>在后面在readExternal中需要注意，要想真正绕过白名单，不能在Externalizable 实例的readExternal里调用原生的readObject方法，不然还是会受黑名单影响。</p>
<p>举例，在传入的ClassTableEntry对象的descriptor属性中传入weblogic.cache.RefWrapper对应的ObjectStreamClass对象。该类实现了Externalizable接口，同时该类的readExternal方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput oi)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">    <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nosoftrefs) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hardref = o;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.softref = <span class="keyword">new</span> <span class="title class_">SoftReference</span>(o);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个<code>in.readObject()</code>处打个断点,，按照文章前面提到的数据发送流程发送数据后，再进入readObject跟几步，利用栈如下：</p>
<p><img src="/img/t3/image_urBQSlQPUZ.png"></p>
<p>可以发现程序又进入了readObjectFromPreDiabloPeer方法。原因在于默认传入的ObjectInput和在MsgAbbrevInputStream中被readObject的是同一个流，依然会受白名单的影响。那么如何把这个流替换成其他的呢？其实也很简单。&amp;#x20;</p>
<p>在Externalizable接口的实现类中，很常见的会看见这种写法，这里以com.tangosol.coherence.servlet.AttributeHolder为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>.m_sName = ExternalizableHelper.readUTF(in);</span><br><span class="line">    <span class="built_in">this</span>.m_oValue = ExternalizableHelper.readObject(in);</span><br><span class="line">    <span class="built_in">this</span>.m_fActivationListener = in.readBoolean();</span><br><span class="line">    <span class="built_in">this</span>.m_fBindingListener = in.readBoolean();</span><br><span class="line">    <span class="built_in">this</span>.m_fLocal = in.readBoolean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它在反序列化的过程中使用的是ExternalizableHelper.readObject方法。它在反序列化过程中根据序列化的数据类型不同，存在许多自定义的逻辑。其中在反序列化利用链中最常用是下面这两种，我们重点关注它们对流是否存在转换和处理</p>
<p><img src="/img/t3/image_ihHtzGHBwb.png"></p>
<p>第一个是反序列化实现了ExternalizableLite接口的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Class&lt;?&gt; clz = loadClass(sClass, loader, inWrapper == <span class="literal">null</span> ? <span class="literal">null</span> : inWrapper.getClassLoader());</span><br><span class="line">  <span class="keyword">if</span> (in <span class="keyword">instanceof</span> ObjectInputStream) &#123;</span><br><span class="line">      <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> (ObjectInputStream)in;</span><br><span class="line">      <span class="keyword">if</span> (!checkObjectInputFilter(clz, ois)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Deserialization of class &quot;</span> + sClass + <span class="string">&quot; was rejected&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  value = (ExternalizableLite)clz.newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException var7) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Unable to instantiate an instance of class &#x27;&quot;</span> + sClass + <span class="string">&quot;&#x27;; this is most likely due to a missing public no-args constructor: &quot;</span> + var7 + <span class="string">&quot;\n&quot;</span> + getStackTrace(var7) + <span class="string">&quot;\nClass: &quot;</span> + sClass + <span class="string">&quot;\nClassLoader: &quot;</span> + loader + <span class="string">&quot;\nContextClassLoader: &quot;</span> + getContextClassLoader());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Class initialization failed: &quot;</span> + var8 + <span class="string">&quot;\n&quot;</span> + getStackTrace(var8) + <span class="string">&quot;\nClass: &quot;</span> + sClass + <span class="string">&quot;\nClassLoader: &quot;</span> + loader + <span class="string">&quot;\nContextClassLoader: &quot;</span> + getContextClassLoader(), var8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (inWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">      in = <span class="keyword">new</span> <span class="title class_">WrapperDataInputStream</span>((DataInput)in, loader);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loader != inWrapper.getClassLoader()) &#123;</span><br><span class="line">      inWrapper.setClassLoader(loader);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">value.readExternal((DataInput)in);</span><br><span class="line"><span class="keyword">if</span> (value <span class="keyword">instanceof</span> SerializerAware) &#123;</span><br><span class="line">  ((SerializerAware)value).setContextSerializer(ensureSerializer(loader));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是一段黑名单判断，这应该是之前某个二次反序列化话的补丁。黑名单后就会newInstance，然后会生成一个新的WrapperDataInputStream对象，这看起来像是对流进行了转化，但其实只是一层封装，在实际的readObject过程中还是使用的原始流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (inWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">      in = <span class="keyword">new</span> <span class="title class_">WrapperDataInputStream</span>((DataInput)in, loader);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loader != inWrapper.getClassLoader()) &#123;</span><br><span class="line">      inWrapper.setClassLoader(loader);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此重点需要关注第二个readSerializable方法了。这个方法是对常规的序列化的封装。在执行readObject前存在这样一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInput</span> <span class="variable">streamObj</span> <span class="operator">=</span> getObjectInput(in, loader);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在高版本的Weblogic中，最终是执行下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ObjectInput <span class="title function_">getObjectInput</span><span class="params">(DataInput in, ClassLoader loader, <span class="type">boolean</span> fForceNew)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!fForceNew &amp;&amp; in <span class="keyword">instanceof</span> WLSObjectInputStream) &#123;</span><br><span class="line">        <span class="keyword">return</span> (ObjectInput)in;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getInputStream(in, fForceNew);</span><br><span class="line">        loader = loader == <span class="literal">null</span> &amp;&amp; in <span class="keyword">instanceof</span> WrapperDataInputStream ? ((WrapperDataInputStream)in).getClassLoader() : loader;</span><br><span class="line">        <span class="keyword">return</span> (ObjectInput)(loader == <span class="literal">null</span> &amp;&amp; in <span class="keyword">instanceof</span> FilteringObjectInputStream ? (ObjectInput)in : <span class="keyword">new</span> <span class="title class_">WLSObjectInputStream</span>(inStream, RemoteObjectReplacer.getReplacer(), <span class="keyword">new</span> <span class="title class_">ClassLoaderResolver</span>(loader), loader, <span class="built_in">this</span>.setFilter));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在T3反序列化中，会生成一个新的WLSObjectInputStream对象作为流，从而摆脱了白名单。</p>
<p><img src="/img/t3/image_F5UsaV7BiB.png"></p>
<p>下面是测试的调用栈。</p>
<p><img src="/img/t3/image_WVBI0NwH_C.png"></p>
<p>在进入WLSObjectInputStream的readObject后，构建符合要求的数据流，即可正常反序列化，在这一步的实操中，我利用程序自身的序列化方法进行序列化的数据，在反序列化时都失败了，可能需要对字节码的一些字段进行手动修改，本文只提出T3协议的绕过方法，后续的WLSObjectInputStream的readObject实现，有兴趣的师傅可以自行尝试。</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
    data-repo="YYHYlh/YYHYlh.github.io"
    data-repo-id="R_kgDOJjKWvw"
    data-category="Announcements"
    data-category-id="DIC_kwDOJjKWv84CWs3N"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
</script>




</html>
